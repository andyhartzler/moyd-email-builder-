{{ define "subscription-form" }}
{{ template "header" . }}

<section class="subscription-form-section">
    <h2>{{ L.T "public.subTitle" }}</h2>
    <p class="subtitle">Stay informed about Missouri Young Democrats news, events, and action opportunities.</p>

    <!-- Status Messages -->
    <div id="form-message" class="form-message" style="display: none;"></div>

    <form id="subscribe-form" class="form" onsubmit="return handleSubscribe(event)">
        <div>
            <!-- Full Name (Required) -->
            <div class="form-group">
                <label for="name">Full Name <span class="required">*</span></label>
                <input id="name" name="name" type="text" placeholder="Your full name" required />
            </div>

            <!-- Email (Required) -->
            <div class="form-group">
                <label for="email">{{ L.T "subscribers.email" }} <span class="required">*</span></label>
                <input id="email" name="email" type="email" placeholder="your@email.com" required />
                <!-- Honeypot field for spam protection -->
                <input name="nonce" class="nonce" value="" />
            </div>

            <!-- Phone (Optional) -->
            <div class="form-group">
                <label for="phone">Phone Number</label>
                <input id="phone" name="phone" type="tel" placeholder="(555) 123-4567" />
            </div>

            <!-- Date of Birth (Required) -->
            <div class="form-group">
                <label for="dob">Date of Birth <span class="required">*</span></label>
                <input id="dob" name="dob" type="date" required />
            </div>

            <!-- Zip Code (Required) -->
            <div class="form-group">
                <label for="zip">Zip Code <span class="required">*</span></label>
                <input id="zip" name="zip" type="text" placeholder="65201" pattern="[0-9]{5}" maxlength="5" required />
            </div>

            {{ if .Data.Lists }}
            <div class="form-group lists-group">
                <h3>{{ L.T "globals.terms.lists" }}</h3>
                <ul class="lists">
                    {{ range $i, $l := .Data.Lists }}
                        <li>
                            <input checked="true" id="l-{{ $l.UUID }}" type="checkbox" name="l" value="{{ $l.UUID }}" />
                            <label for="l-{{ $l.UUID }}">{{ $l.Name }}</label>
                            {{ if ne $l.Description "" }}
                                <p class="description">{{ $l.Description }}</p>
                            {{ end }}
                        </li>
                    {{ end }}
                </ul>
            </div>
            {{ end }}

            {{ if .Data.Captcha.Enabled }}
                <div class="captcha">
                    {{ if eq .Data.Captcha.Provider "hcaptcha" }}
                        <div class="h-captcha" data-sitekey="{{ .Data.Captcha.Key }}"></div>
                        <script src="https://js.hcaptcha.com/1/api.js" async defer></script>
                    {{ else if eq .Data.Captcha.Provider "altcha" }}
                        <altcha-widget challengeurl="{{ .RootURL }}/api/public/captcha/altcha"></altcha-widget>
                        <script type="module" src="{{ .RootURL }}/public/static/altcha.umd.js" async defer></script>
                    {{ end }}
                </div>
            {{ end }}

            <div class="submit-section">
                <button type="submit" class="button" id="btn-submit">{{ L.T "public.sub" }}</button>
            </div>

            {{ if .EnablePublicArchive }}
                <p class="right archive-link">
                    <a href="{{ .RootURL }}/archive">{{ L.T "public.archiveTitle" }}</a>
                </p>
            {{ end }}

            <p class="privacy-notice">We respect your privacy and will never share your information.</p>
        </div>
    </form>
</section>

<script>
// Supabase Edge Function endpoint for custom attribute handling
var SUBSCRIBE_ENDPOINT = 'https://ixfyreolqilplctqzpfq.supabase.co/functions/v1/listmonk-subscribe';

function showMessage(type, text) {
    var msgEl = document.getElementById('form-message');
    msgEl.className = 'form-message ' + type;
    msgEl.textContent = text;
    msgEl.style.display = 'block';
    msgEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
}

function formatPhone(phone) {
    // Remove non-digits
    var digits = phone.replace(/\D/g, '');
    // Format as E.164 for US numbers
    if (digits.length === 10) {
        return '+1' + digits;
    } else if (digits.length === 11 && digits.charAt(0) === '1') {
        return '+' + digits;
    }
    return phone;
}

function handleSubscribe(e) {
    e.preventDefault();

    var form = document.getElementById('subscribe-form');
    var submitBtn = document.getElementById('btn-submit');

    // Check honeypot
    var nonce = form.querySelector('input[name="nonce"]');
    if (nonce && nonce.value !== '') {
        showMessage('error', 'Spam detected.');
        return false;
    }

    // Collect form data
    var name = form.querySelector('#name').value.trim();
    var email = form.querySelector('#email').value.trim();
    var phone = form.querySelector('#phone').value.trim();
    var dob = form.querySelector('#dob').value;
    var zip = form.querySelector('#zip').value.trim();

    // Get selected lists
    var lists = [];
    form.querySelectorAll('input[name="l"]:checked').forEach(function(cb) {
        lists.push(cb.value);
    });

    // Validate required fields
    if (!name || !email || !dob || !zip) {
        showMessage('error', 'Please fill in all required fields.');
        return false;
    }

    // Validate zip code
    if (!/^\d{5}$/.test(zip)) {
        showMessage('error', 'Please enter a valid 5-digit zip code.');
        return false;
    }

    // Disable submit button
    submitBtn.disabled = true;
    submitBtn.textContent = 'Subscribing...';

    // Build request payload
    var payload = {
        name: name,
        email: email,
        lists: lists,
        attribs: {
            dob: dob,
            zip: zip
        }
    };

    // Add phone if provided
    if (phone) {
        payload.attribs.phone = formatPhone(phone);
    }

    // Submit to Supabase Edge Function
    fetch(SUBSCRIBE_ENDPOINT, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(payload)
    })
    .then(function(response) {
        return response.json().then(function(data) {
            return { ok: response.ok, data: data };
        });
    })
    .then(function(result) {
        if (result.ok) {
            showMessage('success', 'Thank you for subscribing! Please check your email to confirm.');
            form.reset();
        } else {
            var errorMsg = result.data.error || 'Subscription failed. Please try again.';
            showMessage('error', errorMsg);
        }
    })
    .catch(function(err) {
        console.error('Subscribe error:', err);
        showMessage('error', 'Network error. Please try again.');
    })
    .finally(function() {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Subscribe';
    });

    return false;
}
</script>

{{ template "footer" . }}
{{ end }}
