{{ define "subscription-form" }}
{{ template "header" . }}

<section class="subscription-form-section">
    <h2>{{ L.T "public.subTitle" }}</h2>
    <p class="subtitle">Stay informed about Missouri Young Democrats news, events, and action opportunities.</p>

    <!-- Error message (hidden by default) -->
    <div id="error-message" class="form-message error" style="display: none;"></div>

    <!-- Success message (hidden by default) -->
    <div id="success-message" class="form-message success" style="display: none;">
        <h3>Thank you for subscribing!</h3>
        <p>Please check your email to confirm your subscription.</p>
    </div>

    <form id="subscribe-form" class="form">
        <div>
            <!-- Honeypot field for spam protection -->
            <input name="nonce" class="nonce" value="" />

            <!-- Full Name (Required) -->
            <div class="form-group">
                <label for="name">Full Name <span class="required">*</span></label>
                <input id="name" name="name" type="text" placeholder="Your full name" required />
            </div>

            <!-- Email (Required) -->
            <div class="form-group">
                <label for="email">{{ L.T "subscribers.email" }} <span class="required">*</span></label>
                <input id="email" name="email" type="email" placeholder="your@email.com" required />
            </div>

            <!-- Phone (Optional) -->
            <div class="form-group">
                <label for="phone">Phone Number</label>
                <input id="phone" name="phone" type="tel" placeholder="(555) 123-4567" />
            </div>

            <!-- Date of Birth (Required) -->
            <div class="form-group">
                <label for="dob">Date of Birth <span class="required">*</span></label>
                <input id="dob" name="dob" type="date" required />
            </div>

            <!-- Zip Code (Required) -->
            <div class="form-group">
                <label for="zip">Zip Code <span class="required">*</span></label>
                <input id="zip" name="zip" type="text" placeholder="63101" required
                       pattern="[0-9]{5}(-[0-9]{4})?" maxlength="10" />
            </div>

            {{ if .Data.Lists }}
            <div class="form-group lists-group">
                <h3>{{ L.T "globals.terms.lists" }}</h3>
                <ul class="lists">
                    {{ range $i, $l := .Data.Lists }}
                        <li>
                            <input checked="true" id="l-{{ $l.UUID }}" type="checkbox" name="l" value="{{ $l.UUID }}" />
                            <label for="l-{{ $l.UUID }}">{{ $l.Name }}</label>
                            {{ if ne $l.Description "" }}
                                <p class="description">{{ $l.Description }}</p>
                            {{ end }}
                        </li>
                    {{ end }}
                </ul>
            </div>
            {{ end }}

            {{ if .Data.Captcha.Enabled }}
                <div class="captcha">
                    {{ if eq .Data.Captcha.Provider "hcaptcha" }}
                        <div class="h-captcha" data-sitekey="{{ .Data.Captcha.Key }}"></div>
                        <script src="https://js.hcaptcha.com/1/api.js" async defer></script>
                    {{ else if eq .Data.Captcha.Provider "altcha" }}
                        <altcha-widget challengeurl="{{ .RootURL }}/api/public/captcha/altcha"></altcha-widget>
                        <script type="module" src="{{ .RootURL }}/public/static/altcha.umd.js" async defer></script>
                    {{ end }}
                </div>
            {{ end }}

            <div class="submit-section">
                <button type="submit" class="button" id="btn-subscribe">{{ L.T "public.sub" }}</button>
            </div>

            {{ if .EnablePublicArchive }}
                <p class="right archive-link">
                    <a href="{{ .RootURL }}/archive">{{ L.T "public.archiveTitle" }}</a>
                </p>
            {{ end }}

            <p class="privacy-notice">We respect your privacy and will never share your information.</p>
        </div>
    </form>
</section>

<script>
// ============================================
// CONFIGURATION - CORRECT SUPABASE URL
// ============================================
var SUBSCRIBE_ENDPOINT = 'https://faajpcarasilbfndzkmd.supabase.co/functions/v1/listmonk-subscribe';

// ============================================
// HELPER FUNCTIONS
// ============================================

// Format phone to E.164
function formatPhoneE164(phone) {
    if (!phone || phone.trim() === '') {
        return { phone: '', phone_e164: '' };
    }

    var digits = phone.replace(/\D/g, '');

    if (digits.length === 0) {
        return { phone: '', phone_e164: '' };
    }

    if (digits.length === 10) {
        return { phone: digits, phone_e164: '+1' + digits };
    } else if (digits.length === 11 && digits.charAt(0) === '1') {
        return { phone: digits.substring(1), phone_e164: '+' + digits };
    }

    return { phone: digits, phone_e164: '+1' + digits };
}

// Show error message
function showError(message) {
    var errorDiv = document.getElementById('error-message');
    errorDiv.textContent = message;
    errorDiv.style.display = 'block';
    errorDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
}

// Hide error message
function hideError() {
    document.getElementById('error-message').style.display = 'none';
}

// Show success message
function showSuccess() {
    document.getElementById('subscribe-form').style.display = 'none';
    var successDiv = document.getElementById('success-message');
    successDiv.style.display = 'block';
    successDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
}

// ============================================
// FORM SUBMISSION HANDLER
// ============================================

document.getElementById('subscribe-form').addEventListener('submit', function(event) {
    event.preventDefault();

    var submitBtn = document.getElementById('btn-subscribe');

    hideError();
    submitBtn.disabled = true;
    submitBtn.textContent = 'Subscribing...';

    // Gather form data
    var name = document.getElementById('name').value.trim();
    var email = document.getElementById('email').value.trim();
    var phone = document.getElementById('phone').value.trim();
    var dob = document.getElementById('dob').value;
    var zip = document.getElementById('zip').value.trim();

    // Check honeypot
    var nonce = document.querySelector('input[name="nonce"]');
    if (nonce && nonce.value !== '') {
        showError('Spam detected.');
        submitBtn.disabled = false;
        submitBtn.textContent = 'Subscribe';
        return;
    }

    // Get selected lists as array
    var listCheckboxes = document.querySelectorAll('input[name="l"]:checked');
    var lists = [];
    listCheckboxes.forEach(function(cb) {
        lists.push(cb.value);
    });

    console.log('[Subscribe] Data:', { name: name, email: email, phone: phone, dob: dob, zip: zip, lists: lists });

    // Validation
    if (!name) {
        showError('Please enter your full name.');
        submitBtn.disabled = false;
        submitBtn.textContent = 'Subscribe';
        return;
    }
    if (!email) {
        showError('Please enter your email address.');
        submitBtn.disabled = false;
        submitBtn.textContent = 'Subscribe';
        return;
    }
    if (!dob) {
        showError('Please enter your date of birth.');
        submitBtn.disabled = false;
        submitBtn.textContent = 'Subscribe';
        return;
    }
    if (!zip) {
        showError('Please enter your zip code.');
        submitBtn.disabled = false;
        submitBtn.textContent = 'Subscribe';
        return;
    }
    if (lists.length === 0) {
        showError('Please select at least one list.');
        submitBtn.disabled = false;
        submitBtn.textContent = 'Subscribe';
        return;
    }

    // Format phone
    var phoneData = formatPhoneE164(phone);

    // Build payload
    var payload = {
        name: name,
        email: email,
        lists: lists,
        attribs: {
            source: 'Subscribe Form',
            phone: phoneData.phone,
            phone_e164: phoneData.phone_e164,
            zip_code: zip,
            date_of_birth: dob
        }
    };

    console.log('[Subscribe] Payload:', JSON.stringify(payload, null, 2));

    // Submit
    fetch(SUBSCRIBE_ENDPOINT, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
    })
    .then(function(response) {
        return response.json().then(function(data) {
            console.log('[Subscribe] Response:', response.status, data);
            if (!response.ok) {
                throw new Error(data.error || 'Subscription failed. Please try again.');
            }
            return data;
        });
    })
    .then(function(result) {
        showSuccess();
    })
    .catch(function(error) {
        console.error('[Subscribe] Error:', error);

        if (error.name === 'TypeError' && error.message === 'Failed to fetch') {
            showError('Network error. Please check your connection and try again.');
        } else {
            showError(error.message || 'An error occurred. Please try again.');
        }

        submitBtn.disabled = false;
        submitBtn.textContent = 'Subscribe';
    });
});

console.log('[Subscribe] Form loaded. Endpoint:', SUBSCRIBE_ENDPOINT);
</script>

{{ template "footer" . }}
{{ end }}
